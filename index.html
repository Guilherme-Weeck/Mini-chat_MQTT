<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>MiniChat MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    /* ===== Reset & layout ===== */
    html,body { height:100%; margin:0; }
    body {
      margin:0;
      font-family: Arial, sans-serif;
      height:100vh;
      display:flex;
      background:#e5f6ff;
      overflow: hidden; /* important: only #chat scrolls */
    }

    /* Sidebar */
    #sidebar {
      width:280px;
      background:#fff;
      border-right:1px solid #ccc;
      display:flex;
      flex-direction:column;
      z-index:20;
    }
    #user-info {
      padding:12px;
      background:#0099ff; color:white;
      display:flex; justify-content:space-between; align-items:center;
    }
    #conversas { flex:1; overflow-y:auto; }
    .contato { padding:12px 15px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
    .nome { font-weight:600; }
    .sub { font-size:0.85rem; color:#666; margin-top:4px; }
    .badge { background:red; color:white; border-radius:12px; padding:2px 8px; font-size:0.8rem; }

    /* Main area */
    #main {
      flex:1;
      display:flex;
      flex-direction:column;
      height:100vh;
      overflow: hidden; /* impede body de rolar */
    }
    header {
      flex-shrink: 0;
      background:#0099ff;
      color:white;
      padding:10px;
      display:flex;
      align-items:center;
      position: sticky;
      top: 0;
      z-index: 15;
    }
    #menuBtn, #backBtn { background:none; border:none; font-size:1.5rem; color:white; margin-right:10px; cursor:pointer; }
    #chatTitle { flex:1; font-weight:700; }

    /* Chat area (scrollable) */
    #chat {
      flex:1;
      overflow-y:auto; /* apenas o chat rola */
      padding:14px 10px 80px; /* espaço para input */
      display:flex;
      flex-direction:column;
      background:url('https://www.transparenttextures.com/patterns/grey-jean.png') repeat;
    }

    /* Message bubble */
    .msg {
      max-width:72%;
      margin:6px 0;
      padding:10px 14px;
      border-radius:16px;
      position:relative;
      font-size:1rem;
      line-height:1.25;
      word-break: break-word;
      display:inline-block;
    }
    .me { background:#aee4ff; align-self:flex-end; }
    .other { background:#ddd; align-self:flex-start; }
    .hora { font-size:0.72rem; color:#555; position:absolute; bottom:6px; right:10px; margin-left:6px; }
    .status { font-size:0.72rem; color:#337ab7; position:absolute; bottom:6px; right:40px; } /* ticks for my messages */

    /* Input area (fixed) */
    #inputArea {
      display:flex; align-items:center;
      padding:8px; background:white; border-top:1px solid #ccc;
      position:fixed; bottom:0; left:0; right:0; z-index:30;
    }
    #emojiBtn { background:none; border:none; font-size:1.6rem; cursor:pointer; margin-right:8px; }
    #msg { flex:1; padding:10px 14px; font-size:1rem; border-radius:24px; border:1px solid #ccc; outline:none; }
    #sendBtn { margin-left:8px; padding:10px 14px; border:none; border-radius:20px; background:#0099ff; color:white; font-size:1rem; cursor:pointer; }
    #emojiPicker { position:fixed; bottom:60px; left:10px; right:10px; max-width:420px; margin:auto; background:white; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.15); display:none; padding:8px; z-index:40; flex-wrap:wrap; }
    .emoji { font-size:1.4rem; padding:8px; cursor:pointer; }

    /* New contact area in sidebar */
    #novoContatoWrap { padding:10px; border-bottom:1px solid #ccc; display:flex; gap:8px; }
    #novoContato { flex:1; padding:8px; border-radius:6px; border:1px solid #ccc; }

    /* Responsive: hide sidebar by default on small screens */
    @media (max-width:768px) {
      #sidebar { display:none; position:absolute; left:0; top:0; bottom:0; z-index:50; width:85%; max-width:320px; box-shadow: 2px 0 8px rgba(0,0,0,0.15); }
      #menuBtn { display:inline; }
    }
    @media (min-width:769px) {
      #menuBtn { display:none; }
    }
    .msg-footer {
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:4px;  /* espaço entre hora e check */
      font-size:0.72rem;
      color:#555;
      margin-top:4px;
    }

  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar" aria-hidden="false">
    <div id="user-info">
      <span id="username">Usuário</span>
      <button onclick="trocarUsuario()" style="background:#ff6666;color:white;border:none;border-radius:8px;padding:6px 8px;cursor:pointer;">Trocar</button>
    </div>

    <!-- Novo contato -->
    <div id="novoContatoWrap">
      <input id="novoContato" placeholder="Novo contato" />
      <button onclick="novoContato()" style="background:#0099ff;color:white;border:none;border-radius:6px;padding:8px 10px;cursor:pointer;">➕</button>
    </div>

    <!-- Lista de conversas -->
    <div id="conversas"></div>
  </div>

  <!-- Área principal -->
  <div id="main">
    <header>
      <button id="menuBtn" onclick="toggleSidebar()">☰</button>
      <button id="backBtn" onclick="fecharConversa()" style="display:none;">←</button>
      <div id="chatTitle">MiniChat</div>
    </header>

    <div id="chat"></div>

    <!-- Emoji picker -->
    <div id="emojiPicker" aria-hidden="true">
      <!-- lista de emojis comuns -->
      <span class="emoji" onclick="inserirEmoji('😀')">😀</span>
      <span class="emoji" onclick="inserirEmoji('😃')">😃</span>
      <span class="emoji" onclick="inserirEmoji('😄')">😄</span>
      <span class="emoji" onclick="inserirEmoji('😉')">😉</span>
      <span class="emoji" onclick="inserirEmoji('😍')">😍</span>
      <span class="emoji" onclick="inserirEmoji('😘')">😘</span>
      <span class="emoji" onclick="inserirEmoji('😎')">😎</span>
      <span class="emoji" onclick="inserirEmoji('😅')">😅</span>
      <span class="emoji" onclick="inserirEmoji('🤣')">🤣</span>
      <span class="emoji" onclick="inserirEmoji('🤔')">🤔</span>
      <span class="emoji" onclick="inserirEmoji('🙌')">🙌</span>
      <span class="emoji" onclick="inserirEmoji('👍')">👍</span>
      <span class="emoji" onclick="inserirEmoji('👎')">👎</span>
      <span class="emoji" onclick="inserirEmoji('🙏')">🙏</span>
      <span class="emoji" onclick="inserirEmoji('🔥')">🔥</span>
    </div>

    <div id="inputArea" style="display:none;">
      <button id="emojiBtn" onclick="toggleEmojiPicker()" aria-label="Abrir emojis">😃</button>
      <input id="msg" placeholder="Digite sua mensagem..." autocomplete="off" />
      <button id="sendBtn" onclick="enviarMensagem()">Enviar</button>
    </div>
  </div>

  <script>
  // ==============================
  // Inicialização
  // ==============================
  let usuario = localStorage.getItem("usuario");
  if (!usuario) {
    usuario = prompt("Digite seu nome de usuário:") || "anonimo_" + Math.floor(Math.random()*1000);
    localStorage.setItem("usuario", usuario);
  }
  document.getElementById("username").textContent = usuario;
  const usuarioSafe = String(usuario).replace(/\s+/g, '_').replace(/[^\w\-]/g, '').slice(0,40);

  // Dados locais
  let conversas = JSON.parse(localStorage.getItem("conversas") || "[]");
  let historico = JSON.parse(localStorage.getItem("historico") || "{}");
  let naoLidas = JSON.parse(localStorage.getItem("naoLidas") || "{}");
  let statusUsuarios = {};
  let topicoAtual = null;
  let destinoAtual = null;

  // conectar MQTT
  const opts = {
    clientId: 'minichat_' + usuarioSafe + '_' + Math.random().toString(16).slice(2,6),
    keepalive: 15,
    clean: true,
    will: {
      topic: `XzzXminichat2025/presenca/${usuarioSafe}`,
      payload: 'offline',
      qos: 1,
      retain: true
    }
  };
  const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", opts);

  let hbTimer = null;

  client.on("connect", () => {
    console.log("Conectado como", usuario);

    // presença
    client.publish(`XzzXminichat2025/presenca/${usuarioSafe}`, "online", { retain:true });
    client.subscribe(`XzzXminichat2025/convites/${usuario}`);
    client.subscribe("XzzXminichat2025/presenca/#");

    // 🔹 Novo modelo: assina tudo e filtra pelo nome local
    client.subscribe("XzzXminichat2025/usuarios/#");
    client.subscribe("XzzXminichat2025/historico/#");

    renderConversas();

    // heartbeat de presença
    if (hbTimer) clearInterval(hbTimer);
    hbTimer = setInterval(() => {
      if (client && client.connected)
        client.publish(`XzzXminichat2025/presenca/${usuarioSafe}`, "online", { retain:true });
    }, 20000);
  });

  client.on("close", () => {
    if (hbTimer) { clearInterval(hbTimer); hbTimer = null; }
  });

  window.addEventListener('beforeunload', () => {
    try {
      if (client && client.connected)
        client.publish(`XzzXminichat2025/presenca/${usuarioSafe}`, "offline", { retain:true });
    } catch(e) {}
  });

  // ==============================
  // Mensagens recebidas
  // ==============================
  client.on("message", (topic, messageBuf) => {
    const message = messageBuf.toString();

    // convite
    if (topic.startsWith("XzzXminichat2025/convites/")) {
      abrirConversa(message);
      return;
    }

    // presença
    if (topic.startsWith("XzzXminichat2025/presenca/")) {
      const u = topic.split("/").pop();
      statusUsuarios[u] = message;
      renderConversas();
      return;
    }

    // 🔹 Conversas diretas
    if (topic.startsWith("XzzXminichat2025/usuarios/")) {
      const nomesTopico = topic.split("/").pop();
      if (!nomesTopico.includes(usuario)) return; // ignora conversas alheias
      const nomes = nomesTopico.split("_");
      const outro = nomes.find(n => n !== usuario);

      const parts = message.split("|");
      const autor = parts[0];
      const texto = parts[1] || "";
      const hora = parts[2] || new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      const msgId = parts[3] || (Date.now()+"-"+Math.random().toString(36).slice(2,7));

        // ACKs
        if (autor === "__ACK__") {
          const tipo = parts[1]; // delivered|read
          const msgIdAck = parts[2];
          marcarStatusLocal(msgIdAck, tipo);
          return;
        }

        // ignora minhas próprias mensagens
        if (autor === usuario) return;

        // se for um contato novo, adiciona automaticamente
        if (!conversas.includes(autor)) {
          conversas.push(autor);
          localStorage.setItem("conversas", JSON.stringify(conversas));
          renderConversas();

          // e já se inscreve no tópico da conversa
          const nomes = [usuario, autor].sort().join("_");
          client.subscribe(`XzzXminichat2025/usuarios/${nomes}`);
        }

        // salva e mostra a mensagem
        salvarMensagem(autor, { id: msgId, autor, msg: texto, hora, status: "delivered" });

        // envia ack de entregue
        setTimeout(() => {
          const nomes = [autor, usuario].sort().join("_");
          const t = `XzzXminichat2025/usuarios/${nomes}`;
          client.publish(t, `__ACK__|delivered|${msgId}|${usuario}`);
        }, 100);

        // mostra no chat ou notifica
        if (autor === destinoAtual) {
          renderHistorico(destinoAtual);
          enviarReadAcksParaContato(autor);
        } else {
          incrementarNaoLidas(autor);
          renderConversas();
          notificarNovaMensagem(autor, texto);
        }
      }

    // 🔹 Histórico (filtrado)
    if (topic.startsWith("XzzXminichat2025/historico/")) {
      const nomesTopico = topic.split("/").pop();
      if (!nomesTopico.includes(usuario)) return; // ignora históricos alheios

      try {
        const nomes = nomesTopico.split("_");
        const outro = nomes.find(n => n !== usuario);
        const dados = JSON.parse(message.toString());
        if (!Array.isArray(dados)) return;

        const local = historico[outro] || [];
        const mapLocal = {};
        local.forEach(m => { if (m && m.id) mapLocal[m.id] = m; });

        const merged = dados.map(d => {
          if (d && d.id && mapLocal[d.id] && mapLocal[d.id].status)
            d.status = mapLocal[d.id].status;
          return d;
        });

        local.forEach(l => {
          if (!merged.find(m => m.id === l.id)) merged.push(l);
        });

        merged.sort((a,b) => String(a.id).localeCompare(String(b.id)));

        historico[outro] = merged;
        localStorage.setItem("historico", JSON.stringify(historico));
        if (destinoAtual === outro) renderHistorico(outro);
        renderConversas();
      } catch(e) {
        console.error("Erro ao ler histórico remoto", e);
      }
    }
  });

  // ==============================
  // Envio e exibição de mensagens
  // ==============================
  function enviarMensagem() {
    const input = document.getElementById("msg");
    const texto = input.value.trim();
    if (!texto || !topicoAtual || !destinoAtual) return;

    const hora = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    const msgId = Date.now() + "-" + Math.random().toString(36).slice(2,7);

    salvarMensagem(destinoAtual, { id: msgId, autor: usuario, msg: texto, hora, status: "sent" });
    renderHistorico(destinoAtual);

    client.publish(topicoAtual, `${usuario}|${texto}|${hora}|${msgId}`);

    const nomes = [usuario, destinoAtual].sort().join("_");
    const topicoHist = `XzzXminichat2025/historico/${nomes}`;
    client.publish(topicoHist, JSON.stringify(historico[destinoAtual] || []), { retain:true });

    input.value = "";
    setTimeout(()=>focusInputAndScroll(),50);
  }

  // ==============================
  // Funções auxiliares (checks, histórico, UI)
  // ==============================
  function marcarStatusLocal(msgId, tipo) {
    for (const contato in historico) {
      const msgs = historico[contato] || [];
      for (let m of msgs) {
        if (m.id === msgId && m.autor === usuario) {
          if (tipo === "delivered" && m.status === "sent") m.status = "delivered";
          else if (tipo === "read") m.status = "read";
          localStorage.setItem("historico", JSON.stringify(historico));
          if (contato === destinoAtual) renderHistorico(destinoAtual);
          renderConversas();
          return;
        }
      }
    }
  }

  function enviarReadAcksParaContato(contato) {
    const msgs = historico[contato] || [];
    msgs.forEach(m => {
      if (m.autor !== usuario && m.status !== "read") {
        client.publish(topicoAtual, "__ACK__|read|" + m.id + "|" + usuario);
        m.status = "read";
      }
    });
    localStorage.setItem("historico", JSON.stringify(historico));
    renderHistorico(contato);
  }

  function salvarMensagem(contato, msgObj) {
    if (!historico[contato]) historico[contato] = [];
    historico[contato].push(msgObj);
    localStorage.setItem("historico", JSON.stringify(historico));
  }

  function renderHistorico(contato) {
    const chat = document.getElementById("chat");
    chat.innerHTML = "";
    const msgs = historico[contato] || [];
    msgs.forEach(m => {
      const div = document.createElement("div");
      div.className = "msg " + (m.autor === usuario ? "me" : "other");
      const corpo = document.createElement("div");
      corpo.textContent = m.msg;
      const footer = document.createElement("div");
      footer.className = "msg-footer";
      const hora = document.createElement("span");
      hora.textContent = m.hora + " ";
      footer.appendChild(hora);
      if (m.autor === usuario) {
        const st = document.createElement("span");
        st.textContent = (m.status === "read" ? "✓✓" : (m.status === "delivered" ? "✓" : ""));
        footer.appendChild(st);
      }
      div.appendChild(corpo);
      div.appendChild(footer);
      chat.appendChild(div);
    });
    setTimeout(()=>chat.scrollTop=chat.scrollHeight,50);
  }

  function incrementarNaoLidas(contato){
    naoLidas[contato]=(naoLidas[contato]||0)+1;
    localStorage.setItem("naoLidas", JSON.stringify(naoLidas));
  }

  // ==============================
  // UI e controle
  // ==============================
  function abrirConversa(destino){
    destinoAtual = destino;
    const nomes = [usuario, destino].sort().join("_");
    topicoAtual = `XzzXminichat2025/usuarios/${nomes}`;
    client.subscribe(topicoAtual);
    document.getElementById("chatTitle").textContent = destino + " " + (statusUsuarios[destino]==="online"?"🟢":"⚪");
    document.getElementById("inputArea").style.display="flex";
    document.getElementById("backBtn").style.display="inline";
    document.getElementById("menuBtn").style.display="none";
    renderHistorico(destino);
    if (!conversas.includes(destino)) {
      conversas.push(destino);
      localStorage.setItem("conversas", JSON.stringify(conversas));
    }
    naoLidas[destino]=0;
    localStorage.setItem("naoLidas", JSON.stringify(naoLidas));
    renderConversas();
    enviarReadAcksParaContato(destino);
    if (window.innerWidth<=768) document.getElementById("sidebar").style.display="none";
    setTimeout(()=>focusInputAndScroll(),200);
  }

  function focusInputAndScroll(){
    const input=document.getElementById("msg");
    input.focus({preventScroll:true});
    setTimeout(()=>{const chat=document.getElementById("chat"); chat.scrollTop=chat.scrollHeight;},200);
  }

  renderConversas();
</script>
</body>
</html>
