<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>MiniChat MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; height:100vh; display:flex; background:#e5f6ff; }
    /* Sidebar */
    #sidebar { width:280px; background:#fff; border-right:1px solid #ccc; display:flex; flex-direction:column; }
    #user-info { padding:12px; background:#0099ff; color:white; display:flex; justify-content:space-between; align-items:center; }
    #conversas { flex:1; overflow-y:auto; }
    .contato { padding:15px; border-bottom:1px solid #eee; cursor:pointer; display:flex; justify-content:space-between; }
    .nome { font-weight:bold; }
    .badge { background:red; color:white; border-radius:12px; padding:2px 6px; font-size:0.8rem; }
    /* √Årea principal */
    #main { flex:1; display:flex; flex-direction:column; }
    header { background:#0099ff; color:white; padding:10px; display:flex; align-items:center; }
    #menuBtn, #backBtn { background:none; border:none; font-size:1.5rem; color:white; margin-right:10px; cursor:pointer; }
    #chatTitle { flex:1; font-weight:bold; }
    #chat { flex:1; overflow-y:auto; padding:10px; background:url('https://www.transparenttextures.com/patterns/grey-jean.png') repeat; display:flex; flex-direction:column; }
    .msg { max-width:70%; margin:5px; padding:10px 14px; border-radius:16px; position:relative; font-size:1rem; }
    .me { background:#aee4ff; align-self:flex-end; }
    .other { background:#ddd; align-self:flex-start; }
    .hora { font-size:0.7rem; color:#555; position:absolute; bottom:2px; right:8px; }
    #inputArea { display:flex; padding:8px; background:white; border-top:1px solid #ccc; position:fixed; bottom:0; left:0; right:0; }
    #emojiBtn { background:none; border:none; font-size:1.4rem; cursor:pointer; margin-right:5px; }
    #msg { flex:1; padding:10px; font-size:1rem; border-radius:20px; border:1px solid #ccc; }
    #sendBtn { margin-left:5px; padding:10px 16px; border:none; border-radius:20px; background:#0099ff; color:white; font-size:1rem; cursor:pointer; }
    /* Responsividade */
    @media (max-width:768px) {
      #sidebar { display:none; position:absolute; left:0; top:0; bottom:0; z-index:10; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
  <div id="user-info">
    <span id="username"></span>
    <button onclick="trocarUsuario()" 
      style="background:#ff6666;color:white;border:none;border-radius:8px;padding:4px 8px;cursor:pointer;">
      Trocar
    </button>
  </div>

  <!-- Novo contato -->
  <div style="padding:10px; border-bottom:1px solid #ccc;">
    <input type="text" id="novoContato" placeholder="Novo contato" style="width:70%;padding:6px;">
    <button onclick="novoContato()" style="padding:6px 10px; background:#0099ff; color:white; border:none; border-radius:6px;">‚ûï</button>
  </div>

  <!-- Lista de conversas -->
  <div id="conversas"></div>
  </div>


  <!-- √Årea principal -->
  <div id="main">
    <header>
      <button id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>
      <button id="backBtn" onclick="fecharConversa()" style="display:none;">‚Üê</button>
      <span id="chatTitle">MiniChat</span>
    </header>
    <div id="chat"></div>
    <div id="inputArea" style="display:none;">
      <button id="emojiBtn" onclick="adicionarEmoji('üòÄ')">üòÉ</button>
      <input type="text" id="msg" placeholder="Digite sua mensagem...">
      <button id="sendBtn" onclick="enviarMensagem()">Enviar</button>
    </div>
  </div>

  <script>
    // ==============================
    // Configura√ß√£o inicial
    // ==============================
    let usuario = localStorage.getItem("usuario");
    if (!usuario) {
      usuario = prompt("Digite seu nome de usu√°rio:") || "anonimo_" + Math.floor(Math.random()*1000);
      localStorage.setItem("usuario", usuario);
    }
    document.getElementById("username").textContent = usuario;

    let conversas = JSON.parse(localStorage.getItem("conversas") || "[]");
    let historico = JSON.parse(localStorage.getItem("historico") || "{}");
    let naoLidas = JSON.parse(localStorage.getItem("naoLidas") || "{}");
    let statusUsuarios = {};
    let topicoAtual = null;
    let destinoAtual = null;

    const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt");

    // ==============================
    // Conex√£o
    // ==============================
    client.on("connect", () => {
      client.publish("XzzXminichat2025/presenca/" + usuario, "online", { retain:true });
      client.subscribe("XzzXminichat2025/convites/" + usuario);
      client.subscribe("XzzXminichat2025/presenca/#");
      renderConversas();
    });

    // ==============================
    // Receber mensagens
    // ==============================
    client.on("message", (topic, message) => {
      const msg = message.toString();

      if (topic.startsWith("XzzXminichat2025/convites/")) {
        abrirConversa(msg);
        return;
      }

      if (topic.startsWith("XzzXminichat2025/presenca/")) {
        const usuarioPresenca = topic.split("/").pop();
        statusUsuarios[usuarioPresenca] = msg;
        renderConversas();
        return;
      }

      if (topic.startsWith("XzzXminichat2025/usuarios/")) {
        const [autor, conteudo, hora] = msg.split("|",3);
        if (autor === usuario) return;

        salvarMensagem(autor, { autor, msg:conteudo, hora });
        if (autor !== destinoAtual) {
          incrementarNaoLidas(autor);
          renderConversas();
          notificarNovaMensagem(autor, conteudo);
        } else {
          renderHistorico(destinoAtual);
        }
      }
    });

    // ==============================
    // Fun√ß√µes principais
    // ==============================
    function iniciarConversa(destino) {
      if (!destino) return;
      abrirConversa(destino);
      client.publish("XzzXminichat2025/convites/" + destino, usuario);
    }

    function abrirConversa(destino) {
      destinoAtual = destino;
      const nomes = [usuario, destino].sort().join("_");
      topicoAtual = `XzzXminichat2025/usuarios/${nomes}`;

      client.subscribe(topicoAtual);
      document.getElementById("chatTitle").textContent = destino + " " + (statusUsuarios[destino]==="online"?"üü¢":"‚ö™");
      document.getElementById("inputArea").style.display = "flex";
      document.getElementById("backBtn").style.display = "inline";
      document.getElementById("menuBtn").style.display = "none";
      renderHistorico(destino);

      if (!conversas.includes(destino)) {
        conversas.push(destino);
        localStorage.setItem("conversas", JSON.stringify(conversas));
      }
      naoLidas[destino] = 0;
      localStorage.setItem("naoLidas", JSON.stringify(naoLidas));
      renderConversas();

      // üîπ Fechar sidebar automaticamente no mobile
      if (window.innerWidth <= 768) {
        document.getElementById("sidebar").style.display = "none";
      }
    }


    function fecharConversa() {
      destinoAtual = null;
      topicoAtual = null;
      document.getElementById("chatTitle").textContent = "MiniChat";
      document.getElementById("chat").innerHTML = "";
      document.getElementById("inputArea").style.display = "none";
      document.getElementById("backBtn").style.display = "none";
      document.getElementById("menuBtn").style.display = "inline";
    }

    function enviarMensagem() {
      const input = document.getElementById("msg");
      const texto = input.value.trim();
      if (!texto || !topicoAtual) return;
      const hora = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      client.publish(topicoAtual, usuario + "|" + texto + "|" + hora);
      salvarMensagem(destinoAtual, { autor:"eu", msg:texto, hora });
      renderHistorico(destinoAtual);
      input.value="";
    }

    function salvarMensagem(contato, msg) {
      if (!historico[contato]) historico[contato] = [];
      historico[contato].push(msg);
      localStorage.setItem("historico", JSON.stringify(historico));
    }

    function renderHistorico(contato) {
      const chat = document.getElementById("chat");
      chat.innerHTML="";
      (historico[contato]||[]).forEach(m=>{
        const div=document.createElement("div");
        div.className="msg " + (m.autor==="eu"?"me":"other");
        div.innerHTML= m.msg + `<span class="hora">${m.hora}</span>`;
        chat.appendChild(div);
      });
      chat.scrollTop = chat.scrollHeight;
    }

    function renderConversas() {
      const lista=document.getElementById("conversas");
      lista.innerHTML="";
      conversas.forEach(c=>{
        const div=document.createElement("div");
        div.className="contato";
        div.innerHTML = `<span class="nome">${c} ${statusUsuarios[c]==="online"?"üü¢":"‚ö™"}</span>` +
                        (naoLidas[c]>0?`<span class="badge">${naoLidas[c]}</span>`:"");
        div.onclick=()=>abrirConversa(c);
        lista.appendChild(div);
      });
    }

    function incrementarNaoLidas(contato){
      naoLidas[contato]=(naoLidas[contato]||0)+1;
      localStorage.setItem("naoLidas", JSON.stringify(naoLidas));
    }

    function notificarNovaMensagem(remetente, texto){
      if (Notification.permission==="granted"){
        new Notification("Nova mensagem de "+remetente,{body:texto,icon:"https://cdn-icons-png.flaticon.com/512/1384/1384031.png"});
      } else if (Notification.permission!=="denied"){
        Notification.requestPermission();
      }
      new Audio("https://notificationsounds.com/storage/sounds/file-sounds-1152-pristine.mp3").play();
    }

    function adicionarEmoji(e){
      const input=document.getElementById("msg");
      input.value+=e;
      input.focus();
    }

    function toggleSidebar(){
      const sb=document.getElementById("sidebar");
      sb.style.display = (sb.style.display==="block"?"none":"block");
    }

    function trocarUsuario(){
      localStorage.clear();
      location.reload();
    }

    function novoContato() {
    const nome = document.getElementById("novoContato").value.trim();
    if (!nome) return;
    iniciarConversa(nome);
    document.getElementById("novoContato").value = "";
    toggleSidebar(); // fecha sidebar no mobile para j√° ir pro chat
    }

  </script>
</body>
</html>
